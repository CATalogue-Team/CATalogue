# CATalogue 测试覆盖率提升计划

## 当前覆盖率状况
- 整体覆盖率：45%
- 关键模块覆盖率：
  - `app/routes/cats.py`: 63%
  - `app/services/cat_service.py`: 15%
  - `app/api/auth.py`: 58%
  - `app/core/base_crud.py`: 44%
- 目标覆盖率：95%+

## 提升策略

### 1. 优先覆盖核心业务模块
- **猫咪管理模块** (`app/routes/cats.py` 和 `app/services/cat_service.py`)
  - 添加边界值测试（年龄边界、名称长度等）
  - 覆盖异常处理分支（数据库错误、权限验证等）
  - 测试批量操作功能（批量创建/更新）
  
- **用户认证模块** (`app/routes/auth.py`)
  - 添加密码强度验证测试
  - 覆盖令牌过期场景
  - 测试权限控制逻辑

### 2. 重构大型测试文件
- 将 `tests/routes/test_cats.py` 拆分为：
  - `test_cats_api.py`：API接口测试
  - `test_cats_web.py`：Web界面测试
  - `test_cats_image.py`：图片上传功能测试

### 3. 添加集成测试
- 数据库操作测试：
  - 事务回滚场景
  - 并发操作测试
- 文件上传测试：
  - 大文件上传
  - 非法文件类型处理
- API端到端测试：
  - 认证流程
  - 数据一致性验证

### 4. 覆盖核心工具类
- `app/core/base_crud.py`：
  - 添加CRUD操作测试
  - 覆盖分页和搜索功能
- `app/decorators.py`：
  - 测试权限装饰器
  - 覆盖异常处理逻辑

### 5. 性能测试覆盖
- 使用Locust添加负载测试：
  - API响应时间测试
  - 并发用户测试
- 数据库查询性能测试：
  - 索引优化验证
  - 查询效率基准

## 实施步骤

1. **创建测试脚手架**（预计1天）
   - 添加测试数据工厂
   - 配置测试数据库
   - 设置覆盖率报告工具

2. **核心模块测试覆盖**（预计3天）
   - 猫咪管理模块测试
   - 用户认证模块测试
   - 基础CRUD操作测试

3. **边界和异常测试**（预计2天）
   - 输入验证测试
   - 错误处理测试
   - 安全测试（SQL注入、XSS等）

4. **性能测试实施**（预计1天）
   - 配置Locust测试环境
   - 创建性能测试场景
   - 设置性能基准

5. **持续集成集成**（预计0.5天）
   - 配置GitHub Actions
   - 设置覆盖率阈值（95%）
   - 添加测试失败通知

## 关键指标
- 每周覆盖率提升目标：+15%
- 核心模块优先级：
  1. 猫咪管理模块
  2. 用户认证模块
  3. 基础服务模块
- 测试类型分布：
  - 单元测试：60%
  - 集成测试：30%
  - 性能测试：10%

## 风险控制
- **技术风险**：复杂查询性能问题
  - 应对：添加查询性能监控
- **进度风险**：边界条件测试耗时
  - 应对：使用参数化测试提高效率
- **质量风险**：高覆盖率但低质量
  - 应对：添加突变测试验证测试有效性

## 预计成果
- 整体测试覆盖率 ≥95%
- 关键路径测试覆盖率 100%
- API响应时间 ≤500ms
- 数据库查询时间 ≤100ms
