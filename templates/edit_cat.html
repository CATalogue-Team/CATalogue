
{% extends "base.html" %}

{% block content %}
<h2>编辑猫咪信息</h2>
<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.name.label }}
        {{ form.name(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.description.label }}
        {{ form.description(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.image.label }}
        {{ form.image(class="form-control", id="imageUpload") }}
        <div class="image-preview mt-2">
            {% if cat['image'] %}
            <p>当前图片:</p>
            <img id="currentImage" src="{{ url_for('static', filename='uploads/' + cat['image']) }}" width="200" class="img-thumbnail">
            {% else %}
            <p>暂无图片</p>
            <img id="currentImage" style="display:none;" width="200" class="img-thumbnail">
            {% endif %}
            <img id="imagePreview" style="display:none;" width="200" class="img-thumbnail">
        </div>
    </div>
    <button type="submit" class="btn btn-primary">保存</button>
    <a href="{{ url_for('admin.cats') }}" class="btn btn-secondary">取消</a>
</form>

<script>
// 确保DOM加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    const uploadInput = document.getElementById('imageUpload');
    
    // 更健壮的事件监听
    if (uploadInput) {
        uploadInput.addEventListener('change', handleImagePreview);
    }

    function handleImagePreview(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // 验证图片类型
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
            alert('请选择有效的图片格式 (JPEG, PNG, GIF)');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const currentImg = document.getElementById('currentImage');
            const preview = document.getElementById('imagePreview');
            
            if (currentImg) currentImg.style.display = 'none';
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                preview.alt = '图片预览';
            }
        };
        reader.onerror = function() {
            console.error('图片读取失败');
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}
